const DJM=(()=>{const e={},s={};let n="",o="",t="",r=!0,d=!1;const i=async(e="",s)=>{o=e,n=o.substr(o.lastIndexOf("/")+1),await fetch(o).then(e=>e.json()).then(e=>{t=e}).catch(e=>console.log(`[DJM] Error loading "${o}": ${e.message}`)).finally(()=>{s&&"function"==typeof s&&s(t)})},l={_Exclude:(e="")=>{const s=[];return{_AddExclude:(e="",n)=>{s[s.length]={match:e,active:n}},_GetTemplate:()=>({onProp:e,exclude:s})}}},a=new Worker(URL.createObjectURL(new Blob([`onmessage=${e=>{let s;const n={};!function(e,n){void 0===e.instance?(e.nestedNodes=[],e.savedInfo={},e.skipToNode={},e.dataAttribs={},e.dataIndex=0,e.retrievedResponseNodeLevel=0,e.retrievedResponseValueNodeLevel=0,s=e):s=e.instance,n({key:e.key,response:e.response,excludeTemplate:e.excludeTemplate,canAppendResponses:e.canAppendResponses})}(e.data,e=>{!function(e,o,t,r){let{jsonStringKey:d,reloaded:i,dataAttribs:l,dataIndex:a,retrievedResponseNodeLevel:p,retrievedResponseValueNodeLevel:u}=s;const{nestedNodes:c,jsonFileName:v,jsonStringLoaded:f,savedInfo:R,skipToNode:h}=s;R.allNodesExcluded?(s.savedInfo.allNodesExcluded=void 0,postMessage({type:"recall",data:s})):n.isExcluded||""!==o?""!==o&&function(s){if(void 0===l||!l["*DJM_canResponse"]||n.isExcluded&&!R.resultSentBefore)return;if(void 0===l.response.length)throw new Error(`["${v}" >> "${e}"]\nAll 'response' nested properties must be enclosed as array.`);void 0===h[s]&&(h[s]={});const o=void 0===h[s][R.responseId];o&&J(s,R.responseId,0,0);const{parentResponseNodeLevel:t,returnedResponseValueNodeLevel:r}=function(e,s){let o,t,r,d;n.allReturnedResponseExcluded=void 0;const i=h[e][R.responseId],l=R.lastResponseParentNode.response.length;for(let a=0;a<l;a++){R.lastResponseParentNode.response[a]["*isResponseLevel"]=!0;const p=R.lastResponseParentNode.response[a][e];if(p){const e=p.length;for(let n=0;n<e;n++)if(!D(p[n],!0).excluded&&(void 0===o&&(o=a),void 0===r&&(r=n),a===i.parentResponseNodeLevel&&n>i.returnedResponseNodeLevel||s&&n>=i.returnedResponseNodeLevel||a>i.parentResponseNodeLevel)){t=a,d=n;break}}if(void 0!==t)break;a===l-1?(t=o,d=r,n.allReturnedResponseExcluded=void 0===t&&void 0===d,n.allReturnedResponseExcluded||(R.lastResponseParentNode.response[t]["*DJM_skipped"]=void 0,R.lastResponseParentNode.response[t][e][d]["*DJM_skipped"]=void 0)):R.lastResponseParentNode.response[a]["*DJM_skipped"]=!0}return{parentResponseNodeLevel:t,returnedResponseValueNodeLevel:d}}(s,o);if(n.allReturnedResponseExcluded||void 0===r)return;J(s,R.responseId,t,r),p=h[s][R.responseId].parentResponseNodeLevel,u=h[s][R.responseId].returnedResponseNodeLevel,l["*DJM_canResponse"]=l["*DJM_skipped"]=void 0,l["*DJM_returnedResponse"]=s,R.lastReturnedResponse=s,R.hasResponded=!0,c[c.length]=l,g(l.response,p,!0,l["*DJM_returnedResponse"])}(o):g(d,0);function x(e){l["*DJM_canResponse"]||(l=void 0,R.lastResponseParentNode=void 0),R.resultSentBefore="result"===e,s.excludeTemplate=void 0,s.jsonStringKey=d,s.reloaded=i,s.nestedNodes.length=c.length,s.savedInfo=R,s.skipToNode=h,s.dataAttribs=l,s.dataIndex=a,s.retrievedResponseNodeLevel=p,s.retrievedResponseValueNodeLevel=u,postMessage({type:e,data:s})}function J(e,s,n,o){h[e][s]={parentResponseNodeLevel:n,returnedResponseNodeLevel:o}}function _(e,s,n){h[e]={sequenceNodeLevel:s,updateOnNextTime:n}}function M(e,s,n=!1){const o=e[s];return{exists:void 0!==o,value:o,parentLength:n?Object.values(e).length:void 0}}function D(e,s=!1){let n=!1,o=!1;if(t){const r=t.onProp,d=t.exclude;if(r&&d){const t=M(e,r);if(n=n||t.exists,!n)return{nodeHasOnProp:n,excluded:o};const i=d.length;for(let n=0;n<i;n++){const{match:r,active:i}=d[n],l=t.value===r,a=!!+i;if(o=l&&void 0===i||l&&a,o){e["*DJM_finished"]=!s;break}}}}return{nodeHasOnProp:n,excluded:!e["*DJM_hasPendingResponse"]&&o}}function g(s,o=0,t,J,q,N){try{if(!f)throw new Error(`["${v}" >> "${e}"]\nJSON file not loaded.`);if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nThere's no data for the specified JSON key.`);a=o,l=s[a];const I=a,w=M(l,"sequence",!0),b=M(l,"response"),m=M(l,"*repeatResponse"),O=M(l,"*required"),$=M(l,"*alternate");let j=l&&void 0!==l["*DJM_shown"];const y=l&&void 0!==l["*DJM_finished"];let k=l&&void 0!==l["*DJM_skipped"];if(!j){if(w.exists){const s=l.sequence.length;if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nAll 'sequence' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${v}" >> "${e}"]\nAt least must exist one sequence nested node.`)}else if(b.exists){const s=l.response.length;if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nAll 'response' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${v}" >> "${e}"]\nAt least must exist one response value node on 'response' nested node.`)}else{const n=s.length;if(void 0===n)throw new Error(`["${v}" >> "${e}"]\nAll nodes must be enclosed as array.`);if(0===n)throw new Error(`["${v}" >> "${e}"]\nCan't exist empty nodes.`)}if(b.exists&&w.exists)throw new Error(`["${v}" >> "${e}"]\nNodes must not have both 'response' and 'sequence' properties at the same time.`);if(!b.exists&&m.exists)throw new Error(`["${v}" >> "${e}"]\nThe '*repeatResponse' property must exist on parent response nodes only.`);if(!b.exists&&O.exists)throw new Error(`["${v}" >> "${e}"]\nThe '*required' property must exist on parent response nodes only.`);if(!w.exists&&$.exists)throw new Error(`["${v}" >> "${e}"]\nThe '*alternate' property must exist on parent sequence nodes only.`);0===c.length&&(i&&(i=JSON.parse(JSON.stringify(i))),R.rootNodeIndex=++R.rootNodeIndex||0,p=0),R.resultObject=JSON.parse(JSON.stringify(l)),l["*DJM_shown"]=!1}if(y||(l["*DJM_finished"]=!1),b.exists&&(R.isRepeatResponse=void 0),b.exists&&l["*DJM_shown"]){l["*DJM_canResponse"]=void 0;const e=l.response.length;for(let s=0;s<e&&(a=s,l.response[s]["*DJM_finished"]||l.response[s]["*DJM_skipped"]);s++);if(R.canFlow)return c[c.length]=l,void g(l.response,a,!0,l["*DJM_returnedResponse"],!0);if(!R.hasResponded){n.allReturnedResponseExcluded=void 0;let e=!1;for(let s=c.length-1;s>=0;s--){const n=c[s];if(n.sequence){const s=n["*DJM_sequenceId"];if(!D(n).excluded)if(n["*alternate"])_(s,void 0!==h[s]?h[s].sequenceNodeLevel:0,!0);else{const o=n.sequence.length;for(let t=0;t<o;t++)if(k=void 0!==n.sequence[t]["*DJM_skipped"],j=void 0!==n.sequence[t]["*DJM_shown"],!k&&!j){_(`${s}:P`,t),e=!0;break}}}if(e)break}if(c.length=0,R.responseHasPendingAlternateFromParent=void 0,e)R.canFlow=!0,g(d,0);else{if(d.shift(),0===d.length)return R.resultSentBefore=void 0,R.rootNodeIndex=void 0,R.lastResponseParentNode=void 0,p=0,u=0,R.responseId=void 0,R.lastReturnedResponse=void 0,R.lastSequenceIsAlternate=void 0,R.canFlow=void 0,d=i,void g(d,0);g(d,0)}return}}if(t){const s=l[J].length;if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nAll returned response value nested properties must be enclosed as array.`);for(let e=0;e<s&&(a=e,s>1&&u>0&&e<u&&(l[J][e]["*DJM_skipped"]=!0),l[J][e]["*DJM_finished"]||l[J][e]["*DJM_skipped"]);e++);return l["*DJM_shown"]=!0,c[c.length]=l,void g(l[J],a,!1,J,!0)}const L=D(l,q);if(n.isExcluded=L.excluded,!n.isExcluded&&(l["*DJM_shown"]&&w.exists||w.exists&&(1===w.parentLength||($.exists||L.nodeHasOnProp)&&w.parentLength===2+(L.nodeHasOnProp?1:0)))){l["*DJM_shown"]=!0;let e=!1,s=!1;R.responseHasPendingAlternateFromParent||(l["*DJM_sequenceId"]=`root:${R.rootNodeIndex}-parent_response:${p}-index:${I}-level:${c.length}`);const n=l["*DJM_sequenceId"],o=l["*alternate"]=!!+l["*alternate"];o&&(R.lastSequenceIsAlternate=!0,s=void 0!==h[n],s&&h[n].updateOnNextTime&&_(n,function(e){let s,n;void 0===h[e["*DJM_sequenceId"]]&&_(e["*DJM_sequenceId"],0);const o=e.sequence.length;for(let t=0;t<o;t++){if(!D(e.sequence[t]).excluded&&(void 0===s&&(s=t),t>h[e["*DJM_sequenceId"]].sequenceNodeLevel)){n=t;break}t===o-1&&(n=s)}return n}(l)));const t=l.sequence.length;for(let r=0;r<t&&(a=r,o?!s&&D(l.sequence[r]).excluded?l.sequence[r]["*DJM_skipped"]=e=!0:s&&r<h[n].sequenceNodeLevel&&(l.sequence[r]["*DJM_skipped"]=!0):D(l.sequence[r]).excluded&&(l.sequence[r]["*DJM_skipped"]=!0),void 0!==h[`${n}:P`]&&(r<h[`${n}:P`].sequenceNodeLevel?l.sequence[r]["*DJM_skipped"]=!0:h[`${n}:P`]=void 0),!l.sequence[r]["*DJM_canResponse"]&&(l.sequence[r]["*DJM_finished"]||l.sequence[r]["*DJM_skipped"]||l.sequence[r]["*DJM_done"]));r++);return e&&_(n,a),R.responseHasPendingAlternateFromParent||(c[c.length]=l),void g(l.sequence,a,void 0,void 0,void 0,!0)}if(!l["*DJM_shown"]){if(!n.isExcluded){if(R.resultObject.isSequence=N,N&&R.isAlternate&&(R.resultObject.isAlternate=!0,R.isAlternate=void 0),R.resultObject.isResponse=q,R.resultObject.response=q?J:void 0,b.exists&&(R.resultObject.hasResponse=!0),q&&R.isRepeatResponse&&(R.resultObject.isRepeatResponse=!0,R.isRepeatResponse=void 0),w.exists&&(R.resultObject.hasSequence=!0,R.resultObject.sequence=void 0),$.exists&&(+$.value&&(R.isAlternate=!0,R.resultObject.hasAlternate=!0),R.resultObject["*alternate"]=void 0),m.exists&&(+m.value&&(R.isRepeatResponse=!0,R.resultObject.hasRepeatResponse=!0),R.resultObject["*repeatResponse"]=void 0),O.exists){const e=O.value,s=e=>e&&e.constructor&&e.constructor===Object,n=!!+e;R.resultObject.hasRequired=n||s(e),R.resultObject["*required"]=void 0,R.requiredResult=R.resultObject.hasRequired&&n?R.resultObject:e}if(l["*DJM_shown"]=!0,w.exists||b.exists||(l["*DJM_finished"]=!0),w.exists)R.canFlow=void 0!==R.lastReturnedResponse;else if(b.exists){if(l["*DJM_canResponse"]=l["*DJM_skipped"]=!0,R.canFlow=void 0,R.hasResponded=void 0,R.responseId=l["*DJM_responseId"]=`root:${R.rootNodeIndex}-index:${I}-response:${p}-${void 0===R.responseId||void 0===R.lastReturnedResponse?"default":R.lastReturnedResponse}:${c.length}`,R.lastResponseParentNode=l,R.responseHasPendingAlternateFromParent=R.lastSequenceIsAlternate,r){const e=l.response.map(e=>Object.keys(e)).reduce((e,s)=>e.concat(s));R.resultObject.responses=e.filter((s,n)=>e.indexOf(s)===n)}return R.resultObject.isSequence&&(c[c.length-1]["*DJM_hasPendingResponse"]=!0),void x("result")}}let s=!1,o=!1;if(!n.isExcluded||n.isExcluded&&(N||q)){for(let e=c.length-1;e>=0;e--){const n=c[e],t=void 0!==n.sequence,r=n["*alternate"],d=void 0!==n.response;if((q=n["*isResponseLevel"])&&!o){let e=0;const s=n[R.lastReturnedResponse].length;for(let t=0;t<s;t++)if(k=void 0!==n[R.lastReturnedResponse][t]["*DJM_skipped"],k&&e++,n[R.lastReturnedResponse][t]["*DJM_finished"]){o=!0;break}n["*DJM_finished"]=e+(o?1:0)===s}else if(t){s=!0;for(let e=n.sequence.length-1;e>=0&&(n.sequence[e]["*DJM_finished"]||n.sequence[e]["*DJM_skipped"]||n.sequence[e]["*DJM_done"]||n["*alternate"]&&!n.sequence[e]["*DJM_shown"]);e--)n["*DJM_finished"]=0===e,s=!n["*DJM_finished"]}else if(d)if(o)n["*DJM_done"]=!0;else{const e=n.response.length-1;n["*DJM_finished"]=n.response[e]["*DJM_finished"]||n.response[e]["*DJM_skipped"]}if(r&&(n["*DJM_finished"]||n["*DJM_skipped"])&&(currentSequenceId=n["*DJM_sequenceId"],_(currentSequenceId,void 0!==h[currentSequenceId]?h[currentSequenceId].sequenceNodeLevel:0,!0)),o&&s)break}}const t=o&&!s;if((d[0]["*DJM_finished"]||d[0]["*DJM_skipped"]||t)&&d.shift(),t&&(R.responseId=void 0),R.responseHasPendingAlternateFromParent=void 0,p=0,u=0,c.length=0,R.allNodesExcluded=n.isExcluded&&!R.resultSentBefore,0===d.length){if(R.resultSentBefore=void 0,R.rootNodeIndex=void 0,R.responseId=void 0,R.lastResponseParentNode=void 0,R.lastSequenceIsAlternate=void 0,i?(d=i,i=void 0,n.isExcluded?R.allNodesExcluded||g(d,0):x("result")):R.allNodesExcluded||x("recall"),R.allNodesExcluded)throw new Error(`["${v}" >> "${e}"]\nDo not exclude all nodes!`);return}return void(n.isExcluded?g(d,0):x("result"))}}catch(e){R.resultObject=e.message,x("exception")}}}(e.key,e.response,e.excludeTemplate,e.canAppendResponses)})}}`],{type:"application/javascript"}))),p=async(l="",{response:p="",excludeTemplate:u,lock:c=!1,reset:v=!1}={})=>{let f,R;async function h(s){e[l].jsonStringKey=s,x()}async function x(){return new Promise(async(J,_)=>{if(f=f||J,R=R||_,""===t)return void R('First load "DJM._LoadJSONFileAsync()"');let M;if(v?p=(e[l]=s[l]=void 0)||"":s[l]&&""===p?(M=e[l]=s[l],s[l]=void 0):M=e[l],M){if(M.isLoadingJsonFile)return void setTimeout(()=>x(),0);if(c)return void sendResult(M.savedInfo.resultObject);if(M.savedInfo.requiredResult){if(""===p)return M.savedInfo.requiredResult.isRequired=(M.savedInfo.requiredResult.hasRequired=void 0)||!0,d&&(M.savedInfo.requiredResult.responses=M.savedInfo.resultObject.responses),void f(M.savedInfo.requiredResult);M.savedInfo.requiredResult=void 0}M.canPrepareReloaded?e[l].reloaded=t[l]:e[l].reloaded=void 0}a.postMessage(void 0===M?{key:l,jsonFileName:n,jsonStringLoaded:""!==t,jsonStringKey:t[l],reloaded:1===t[l].length,response:p,excludeTemplate:u,canAppendResponses:d}:{key:l,instance:M,response:p,excludeTemplate:u,canAppendResponses:d}),a.onmessage=n=>{const{type:a,data:p}=n.data;if("result"===a){const{resultObject:n}=p.savedInfo,t=p.jsonStringKey.length;let a;if(n.isRepeatResponse?(s[l]={},d&&(p.savedInfo.resultObject.responses=e[l].savedInfo.resultObject.responses),s[l]=p,a=s[l].canPrepareReloaded&&s[l].reloaded,s[l].canPrepareReloaded=1===t):(e[l]=p,a=e[l].canPrepareReloaded&&e[l].reloaded,e[l].canPrepareReloaded=1===t),!a&&t<=1&&r){const n=0===t;s[l]?s[l].isLoadingJsonFile=!0:e[l].isLoadingJsonFile=!0,i(o,o=>{n&&(s[l]?s[l].jsonStringKey=o[l]:e[l].jsonStringKey=o[l]),s[l]?s[l].isLoadingJsonFile=void 0:e[l].isLoadingJsonFile=void 0})}f(n)}else if("recall"===a)e[l]=p,r?i(o,e=>h(e[l])):h(t[l]);else if("exception"===a){const{resultObject:s}=p.savedInfo;e[l]=p,R(s)}}})}return x().then(e=>e).catch(e=>{throw new Error(e)})};return{_LoadJSONFileAsync:i,_Run:p,_RunDebounced:(e=>{let s;return async(n="",{waitTime:o=300,response:t="",excludeTemplate:r,lock:d=!1,reset:i=!1}={})=>(clearTimeout(s),new Promise(l=>{s=setTimeout(()=>l(e(n,{response:t,excludeTemplate:r,lock:d,reset:i})),o)}))})(p),_Settings:({isRefreshable:e=!0,appendResponses:s=!1})=>{r=e,d=s},_TemplateGenerator:l,_IsJSONFileLoaded:""!==t}})();
