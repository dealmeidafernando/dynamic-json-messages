const DJM=(()=>{const e={},s={},n={},t={};let o="",r="",d="",i=!0,a=!1,l=!1,p=!1;const c=async(e="",s)=>{r=e,o=r.substr(r.lastIndexOf("/")+1),await fetch(r).then(e=>e.json()).then(e=>{d=e}).catch(e=>console.log(`[DJM] Error loading "${r}": ${e.message}`)).finally(()=>{s&&"function"==typeof s&&s(d)})},u=(...e)=>{const[s,n]=e;let[,,t]=e,o=s,r=!1;const d=n.merge;if(d){const e=d.length;for(let n=0;n<e;n++){const i=d[n],a=!!+i.active;if((void 0===i.active||a)&&n>t.lastKeyIndex){t.lastKeyIndex=n,o=i.key,r=o===s;break}n===e-1&&(t={},t.lastKeyIndex=-1,t.canUpdateJsonString=!0,t.lastUpdatedKey=void 0)}}return t.swappedKey=o,{nextKey:o,mainKeyManager:t,mainKeyRepeated:r}},v=new Worker(URL.createObjectURL(new Blob([`onmessage = e => postMessage((${u.toString()}).call(this, ...e.data));`],{type:"application/javascript"}))),f=(...e)=>{const[s,n]=e;let t=s[n.onProp];const o=n.replace;if(t&&o){const e=o.length;for(let o=0;o<e;o++){const{here:e,to:r}=n.replace[o];s[n.onProp]=t=t.replace(e,r)}}return s},h=new Worker(URL.createObjectURL(new Blob([`onmessage = e => postMessage((${f.toString()}).call(this, ...e.data));`],{type:"application/javascript"}))),R={_Exclude:(e="")=>{const s=[];return{_AddExclude:(e="",n)=>{s[s.length]={match:e,active:n}},_GetTemplate:()=>({onProp:e,exclude:s})}},_Merge:()=>{const e=[];return{_AddKey:(s="",n)=>{e[e.length]={key:s,active:n}},_GetTemplate:()=>({merge:e})}},_Replace:(e="")=>{const s=[];return{_AddReplace:(e="",n="")=>{s[s.length]={here:e,to:n}},_GetTemplate:()=>({onProp:e,replace:s})}}},g=new Worker(URL.createObjectURL(new Blob([`onmessage=${e=>{let s;const n={};!function(e,n){void 0===e.instance?(e.nestedNodes=[],e.savedInfo={},e.skipToNode={},e.dataAttribs={},e.dataIndex=0,e.retrievedResponseNodeLevel=0,e.retrievedResponseValueNodeLevel=0,s=e):s=e.instance,n({key:e.key,handledKey:e.handledKey,response:e.response,excludeTemplate:e.excludeTemplate,canAppendResponses:e.canAppendResponses})}(e.data,e=>{!function(e,t,o,r,d){let{jsonStringKey:i,reloaded:a,dataAttribs:l,dataIndex:p,retrievedResponseNodeLevel:c,retrievedResponseValueNodeLevel:u}=s;const{nestedNodes:v,jsonFileName:f,jsonStringLoaded:h,savedInfo:R,skipToNode:g}=s;R.allNodesExcluded?(s.savedInfo.allNodesExcluded=void 0,postMessage({type:"recall",swapKey:t,data:s})):n.isExcluded||""!==o?""!==o&&function(s){if(void 0===l||!l["*DJM_canResponse"]||n.isExcluded&&!R.resultSentBefore)return;if(void 0===l.response.length)throw new Error(`["${f}" >> "${e}"]\nAll 'response' nested properties must be enclosed as array.`);void 0===g[s]&&(g[s]={});const t=void 0===g[s][R.responseId];t&&y(s,R.responseId,0,0);const{parentResponseNodeLevel:o,returnedResponseValueNodeLevel:r}=function(e,s){let t,o,r,d;n.allReturnedResponseExcluded=void 0;const i=g[e][R.responseId],a=R.lastResponseParentNode.response.length;for(let l=0;l<a;l++){R.lastResponseParentNode.response[l]["*isResponseLevel"]=!0;const p=R.lastResponseParentNode.response[l][e];if(p){const e=p.length;for(let n=0;n<e;n++)if(!M(p[n],!0).excluded&&(void 0===t&&(t=l),void 0===r&&(r=n),l===i.parentResponseNodeLevel&&n>i.returnedResponseNodeLevel||s&&n>=i.returnedResponseNodeLevel||l>i.parentResponseNodeLevel)){o=l,d=n;break}}if(void 0!==o)break;l===a-1?(o=t,d=r,n.allReturnedResponseExcluded=void 0===o&&void 0===d,n.allReturnedResponseExcluded||(R.lastResponseParentNode.response[o]["*DJM_skipped"]=void 0,R.lastResponseParentNode.response[o][e][d]["*DJM_skipped"]=void 0)):R.lastResponseParentNode.response[l]["*DJM_skipped"]=!0}return{parentResponseNodeLevel:o,returnedResponseValueNodeLevel:d}}(s,t);if(n.allReturnedResponseExcluded||void 0===r)return;y(s,R.responseId,o,r),c=g[s][R.responseId].parentResponseNodeLevel,u=g[s][R.responseId].returnedResponseNodeLevel,l["*DJM_canResponse"]=l["*DJM_skipped"]=void 0,l["*DJM_returnedResponse"]=s,R.lastReturnedResponse=s,R.hasResponded=!0,v[v.length]=l,D(l.response,c,!0,l["*DJM_returnedResponse"])}(o):D(i,0);function x(e,n){l["*DJM_canResponse"]||(l=void 0,R.lastResponseParentNode=void 0),R.resultSentBefore="result"===e,s.excludeTemplate=void 0,s.jsonStringKey=i,s.reloaded=a,s.nestedNodes.length=v.length,s.savedInfo=R,s.skipToNode=g,s.dataAttribs=l,s.dataIndex=p,s.retrievedResponseNodeLevel=c,s.retrievedResponseValueNodeLevel=u,postMessage({type:e,swapKey:n,data:s})}function y(e,s,n,t){g[e][s]={parentResponseNodeLevel:n,returnedResponseNodeLevel:t}}function J(e,s,n){g[e]={sequenceNodeLevel:s,updateOnNextTime:n}}function _(e,s,n=!1){const t=e[s];return{exists:void 0!==t,value:t,parentLength:n?Object.values(e).length:void 0}}function M(e,s=!1){let n=!1,t=!1;if(r){const o=r.onProp,d=r.exclude;if(o&&d){const r=_(e,o);if(n=n||r.exists,!n)return{nodeHasOnProp:n,excluded:t};const i=d.length;for(let n=0;n<i;n++){const{match:o,active:i}=d[n],a=r.value===o,l=!!+i;if(t=a&&void 0===i||a&&l,t){e["*DJM_finished"]=!s;break}}}}return{nodeHasOnProp:n,excluded:!e["*DJM_hasPendingResponse"]&&t}}function D(s,o=0,r,y,m,q){try{if(!h)throw new Error(`["${f}" >> "${e}"]\nJSON file not loaded.`);if(void 0===s)throw new Error(`["${f}" >> "${e}"]\nThere's no data for the specified JSON key.`);p=o,l=s[p];const N=p,w=_(l,"sequence",!0),I=_(l,"response"),b=_(l,"*repeatResponse"),j=_(l,"*required"),k=_(l,"*alternate");let O=l&&void 0!==l["*DJM_shown"];const S=l&&void 0!==l["*DJM_finished"];let $=l&&void 0!==l["*DJM_skipped"];if(!O){if(w.exists){const s=l.sequence.length;if(void 0===s)throw new Error(`["${f}" >> "${e}"]\nAll 'sequence' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${f}" >> "${e}"]\nAt least must exist one sequence nested node.`)}else if(I.exists){const s=l.response.length;if(void 0===s)throw new Error(`["${f}" >> "${e}"]\nAll 'response' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${f}" >> "${e}"]\nAt least must exist one response value node on 'response' nested node.`)}else{const n=s.length;if(void 0===n)throw new Error(`["${f}" >> "${e}"]\nAll nodes must be enclosed as array.`);if(0===n)throw new Error(`["${f}" >> "${e}"]\nCan't exist empty nodes.`)}if(I.exists&&w.exists)throw new Error(`["${f}" >> "${e}"]\nNodes must not have both 'response' and 'sequence' properties at the same time.`);if(!I.exists&&b.exists)throw new Error(`["${f}" >> "${e}"]\nThe '*repeatResponse' property must exist on parent response nodes only.`);if(!I.exists&&j.exists)throw new Error(`["${f}" >> "${e}"]\nThe '*required' property must exist on parent response nodes only.`);if(!w.exists&&k.exists)throw new Error(`["${f}" >> "${e}"]\nThe '*alternate' property must exist on parent sequence nodes only.`);0===v.length&&(a&&(a=JSON.parse(JSON.stringify(a))),R.rootNodeIndex=++R.rootNodeIndex||0,c=0),R.resultObject=JSON.parse(JSON.stringify(l)),l["*DJM_shown"]=!1}if(S||(l["*DJM_finished"]=!1),I.exists&&(R.isRepeatResponse=void 0),I.exists&&l["*DJM_shown"]){l["*DJM_canResponse"]=void 0;const e=l.response.length;for(let s=0;s<e&&(p=s,l.response[s]["*DJM_finished"]||l.response[s]["*DJM_skipped"]);s++);if(R.canFlow)return v[v.length]=l,void D(l.response,p,!0,l["*DJM_returnedResponse"],!0);if(!R.hasResponded){n.allReturnedResponseExcluded=void 0;let e=!1;for(let s=v.length-1;s>=0;s--){const n=v[s];if(n.sequence){const s=n["*DJM_sequenceId"];if(!M(n).excluded)if(n["*alternate"])J(s,void 0!==g[s]?g[s].sequenceNodeLevel:0,!0);else{const t=n.sequence.length;for(let o=0;o<t;o++)if($=void 0!==n.sequence[o]["*DJM_skipped"],O=void 0!==n.sequence[o]["*DJM_shown"],!$&&!O){J(`${s}:P`,o),e=!0;break}}}if(e)break}if(v.length=0,R.responseHasPendingAlternateFromParent=void 0,e)R.canFlow=!0,D(i,0);else{if(i.shift(),0===i.length)return R.resultSentBefore=void 0,R.rootNodeIndex=void 0,R.lastResponseParentNode=void 0,c=0,u=0,R.responseId=void 0,R.lastReturnedResponse=void 0,R.lastSequenceIsAlternate=void 0,R.canFlow=void 0,i=a,void(t?x("recall",!0):D(i,0));D(i,0)}return}}if(r){const s=l[y].length;if(void 0===s)throw new Error(`["${f}" >> "${e}"]\nAll returned response value nested properties must be enclosed as array.`);for(let e=0;e<s&&(p=e,s>1&&u>0&&e<u&&(l[y][e]["*DJM_skipped"]=!0),l[y][e]["*DJM_finished"]||l[y][e]["*DJM_skipped"]);e++);return l["*DJM_shown"]=!0,v[v.length]=l,void D(l[y],p,!1,y,!0)}const L=M(l,m);if(n.isExcluded=L.excluded,!n.isExcluded&&(l["*DJM_shown"]&&w.exists||w.exists&&(1===w.parentLength||(k.exists||L.nodeHasOnProp)&&w.parentLength===2+(L.nodeHasOnProp?1:0)))){l["*DJM_shown"]=!0;let e=!1,s=!1;R.responseHasPendingAlternateFromParent||(l["*DJM_sequenceId"]=`root:${R.rootNodeIndex}-parent_response:${c}-index:${N}-level:${v.length}`);const n=l["*DJM_sequenceId"],t=l["*alternate"]=!!+l["*alternate"];t&&(R.lastSequenceIsAlternate=!0,s=void 0!==g[n],s&&g[n].updateOnNextTime&&J(n,function(e){let s,n;void 0===g[e["*DJM_sequenceId"]]&&J(e["*DJM_sequenceId"],0);const t=e.sequence.length;for(let o=0;o<t;o++){if(!M(e.sequence[o]).excluded&&(void 0===s&&(s=o),o>g[e["*DJM_sequenceId"]].sequenceNodeLevel)){n=o;break}o===t-1&&(n=s)}return n}(l)));const o=l.sequence.length;for(let r=0;r<o&&(p=r,t?!s&&M(l.sequence[r]).excluded?l.sequence[r]["*DJM_skipped"]=e=!0:s&&r<g[n].sequenceNodeLevel&&(l.sequence[r]["*DJM_skipped"]=!0):M(l.sequence[r]).excluded&&(l.sequence[r]["*DJM_skipped"]=!0),void 0!==g[`${n}:P`]&&(r<g[`${n}:P`].sequenceNodeLevel?l.sequence[r]["*DJM_skipped"]=!0:g[`${n}:P`]=void 0),!l.sequence[r]["*DJM_canResponse"]&&(l.sequence[r]["*DJM_finished"]||l.sequence[r]["*DJM_skipped"]||l.sequence[r]["*DJM_done"]));r++);return e&&J(n,p),R.responseHasPendingAlternateFromParent||(v[v.length]=l),void D(l.sequence,p,void 0,void 0,void 0,!0)}if(!l["*DJM_shown"]){if(!n.isExcluded){if(R.resultObject.isSequence=q,q&&R.isAlternate&&(R.resultObject.isAlternate=!0,R.isAlternate=void 0),R.resultObject.isResponse=m,R.resultObject.response=m?y:void 0,I.exists&&(R.resultObject.hasResponse=!0),m&&R.isRepeatResponse&&(R.resultObject.isRepeatResponse=!0,R.isRepeatResponse=void 0),w.exists&&(R.resultObject.hasSequence=!0,R.resultObject.sequence=void 0),k.exists&&(+k.value&&(R.isAlternate=!0,R.resultObject.hasAlternate=!0),R.resultObject["*alternate"]=void 0),b.exists&&(+b.value&&(R.isRepeatResponse=!0,R.resultObject.hasRepeatResponse=!0),R.resultObject["*repeatResponse"]=void 0),j.exists){const e=j.value,s=e=>e&&e.constructor&&e.constructor===Object,n=!!+e;R.resultObject.hasRequired=n||s(e),R.resultObject["*required"]=void 0,R.requiredResult=R.resultObject.hasRequired&&n?R.resultObject:e}if(l["*DJM_shown"]=!0,w.exists||I.exists||(l["*DJM_finished"]=!0),w.exists)R.canFlow=void 0!==R.lastReturnedResponse;else if(I.exists){if(l["*DJM_canResponse"]=l["*DJM_skipped"]=!0,R.canFlow=void 0,R.hasResponded=void 0,R.responseId=l["*DJM_responseId"]=`root:${R.rootNodeIndex}-index:${N}-response:${c}-${void 0===R.responseId||void 0===R.lastReturnedResponse?"default":R.lastReturnedResponse}:${v.length}`,R.lastResponseParentNode=l,R.responseHasPendingAlternateFromParent=R.lastSequenceIsAlternate,d){const e=l.response.map(e=>Object.keys(e)).reduce((e,s)=>e.concat(s));R.resultObject.responses=e.filter((s,n)=>e.indexOf(s)===n)}return R.resultObject.isSequence&&(v[v.length-1]["*DJM_hasPendingResponse"]=!0),void x("result")}}let s=!1,o=!1;if(!n.isExcluded||n.isExcluded&&(q||m)){for(let e=v.length-1;e>=0;e--){const n=v[e],t=void 0!==n.sequence,r=n["*alternate"],d=void 0!==n.response;if((m=n["*isResponseLevel"])&&!o){let e=0;const s=n[R.lastReturnedResponse].length;for(let t=0;t<s;t++)if($=void 0!==n[R.lastReturnedResponse][t]["*DJM_skipped"],$&&e++,n[R.lastReturnedResponse][t]["*DJM_finished"]){o=!0;break}n["*DJM_finished"]=e+(o?1:0)===s}else if(t){s=!0;for(let e=n.sequence.length-1;e>=0&&(n.sequence[e]["*DJM_finished"]||n.sequence[e]["*DJM_skipped"]||n.sequence[e]["*DJM_done"]||n["*alternate"]&&!n.sequence[e]["*DJM_shown"]);e--)n["*DJM_finished"]=0===e,s=!n["*DJM_finished"]}else if(d)if(o)n["*DJM_done"]=!0;else{const e=n.response.length-1;n["*DJM_finished"]=n.response[e]["*DJM_finished"]||n.response[e]["*DJM_skipped"]}if(r&&(n["*DJM_finished"]||n["*DJM_skipped"])&&(currentSequenceId=n["*DJM_sequenceId"],J(currentSequenceId,void 0!==g[currentSequenceId]?g[currentSequenceId].sequenceNodeLevel:0,!0)),o&&s)break}}const r=o&&!s;if((i[0]["*DJM_finished"]||i[0]["*DJM_skipped"]||r)&&i.shift(),r&&(R.responseId=void 0),R.responseHasPendingAlternateFromParent=void 0,c=0,u=0,v.length=0,R.allNodesExcluded=n.isExcluded&&!R.resultSentBefore,0===i.length){if(R.resultSentBefore=void 0,R.rootNodeIndex=void 0,R.responseId=void 0,R.lastResponseParentNode=void 0,R.lastSequenceIsAlternate=void 0,a?(i=a,a=void 0,n.isExcluded?R.allNodesExcluded||D(i,0):x("result")):n.isExcluded?R.allNodesExcluded||x("recall",t):x("result",t),R.allNodesExcluded)throw new Error(`["${f}" >> "${e}"]\nDo not exclude all nodes!`);return}return void(n.isExcluded?D(i,0):x("result"))}}catch(e){R.resultObject=e.message,x("exception")}}}(e.key,e.handledKey,e.response,e.excludeTemplate,e.canAppendResponses)})}}`],{type:"application/javascript"}))),x=async(R="",{response:x="",replaceTemplate:y,excludeTemplate:J,mergeTemplate:_,lock:M=!1,reset:D=!1}={})=>{let m,q,N=n[R];_&&(void 0===N||D)&&(n[R]={},n[R].lastKeyIndex=-1,n[R].swappedKey=R,n[R].pendingReset=D,N=n[R]);const w=R;let I;async function b(e){t[R]&&(D||(e.jsonStringKey=d[R]),t[R]=void 0),g.postMessage(void 0===e?{key:R,jsonFileName:o,jsonStringLoaded:""!==d,jsonStringKey:d[R],handledKey:""===x&&void 0!==_||""!==x&&void 0!==N,response:x,excludeTemplate:J,canAppendResponses:a}:{key:R,instance:e,handledKey:""===x&&void 0!==_||""!==x&&void 0!==N,response:x,excludeTemplate:J,canAppendResponses:a})}async function j(s){e[R].jsonStringKey=s,N&&(n[w].jsonStringKeyDone=!0),O()}async function k(s){const{nextKey:o,mainKeyManager:a,mainKeyRepeated:l}=s;if(l&&q('The main key must not be included in the "Merge Template"'),R=o,n[w]=a,keyInstance=n[w].pendingReset?(t[R]=void 0)||void 0:e[R],keyInstance){const{lastUpdatedKey:s}=a;a.canUpdateJsonString?(i?await c(r,s=>{e[R].jsonStringKey=s[R],keyInstance=e[R]}):(e[R].jsonStringKey=d[R],keyInstance=e[R]),n[w].canUpdateJsonString=void 0):s&&R!==s&&(e[R].jsonStringKey=d[R],keyInstance=e[R]),n[w].lastUpdatedKey=R,t[R]=void 0}return keyInstance}async function O(){function o(e){y?l?(h.postMessage([e,y]),h.onmessage=e=>m(e.data)):m(y?f(e,y):e):m(e)}return new Promise(async(l,f)=>{if(m=m||l,q=q||f,""===d)return void q('First load "DJM._LoadJSONFileAsync()"');let h;if(N&&(R=N.swappedKey),D?x=(e[R]=s[R]=void 0)||"":s[R]&&""===x?(h=e[R]=s[R],s[R]=void 0):h=e[R],h){if(h.isLoadingJsonFile)return void setTimeout(()=>O(),0);if(M)return void o(h.savedInfo.resultObject);if(h.savedInfo.requiredResult){if(""===x)return h.savedInfo.requiredResult.isRequired=(h.savedInfo.requiredResult.hasRequired=void 0)||!0,a&&(h.savedInfo.requiredResult.responses=h.savedInfo.resultObject.responses),void o(h.savedInfo.requiredResult);h.savedInfo.requiredResult=void 0}h.canPrepareReloaded?e[R].reloaded=d[R]:e[R].reloaded=void 0,_&&""===x&&n[w].jsonStringKeyDone?(p?(v.postMessage([w,_,n[w]]),v.onmessage=async e=>b(await k(e.data))):b(await k(u(w,_,n[w]))),n[w].jsonStringKeyDone=void 0):b(h)}else b();g.onmessage=l=>{const{type:p,data:u,swapKey:v}=l.data;if("result"===p){const{resultObject:d}=u.savedInfo,l=u.jsonStringKey.length;let p;if(d.isRepeatResponse?(s[R]={},a&&(u.savedInfo.resultObject.responses=e[R].savedInfo.resultObject.responses),s[R]=u,N||(p=s[R].canPrepareReloaded&&s[R].reloaded,s[R].canPrepareReloaded=1===l)):(e[R]=u,N?t[R]=v:(p=e[R].canPrepareReloaded&&e[R].reloaded,e[R].canPrepareReloaded=1===l)),N)n[w].jsonStringKeyDone=v;else if(!p&&l<=1&&i){const n=0===l;s[R]?s[R].isLoadingJsonFile=!0:e[R].isLoadingJsonFile=!0,c(r,t=>{n&&(s[R]?s[R].jsonStringKey=t[R]:e[R].jsonStringKey=t[R]),s[R]?s[R].isLoadingJsonFile=void 0:e[R].isLoadingJsonFile=void 0})}o(d)}else if("recall"===p)e[R]=u,v?(n[w].jsonStringKeyDone=t[R]=!0,O()):i?c(r,e=>j(e[R])):j(d[R]);else if("exception"===p){const{resultObject:s,allNodesExcluded:t}=u.savedInfo;e[R]=u;const o=N&&t&&-1===n[w].lastKeyIndex;!N||!t||o&&I?q(s):(o&&(I=!0),n[w].jsonStringKeyDone=!0,O())}}})}return O().then(e=>e).catch(e=>{throw new Error(e)})};return{_LoadJSONFileAsync:c,_Run:x,_RunDebounced:(e=>{let s;return async(n="",{waitTime:t=300,response:o="",replaceTemplate:r,excludeTemplate:d,mergeTemplate:i,lock:a=!1,reset:l=!1}={})=>(clearTimeout(s),new Promise(p=>{s=setTimeout(()=>p(e(n,{response:o,replaceTemplate:r,excludeTemplate:d,mergeTemplate:i,lock:a,reset:l})),t)}))})(x),_Settings:({isRefreshable:e=!0,appendResponses:s=!1,replaceOnWorker:n=!1,mergeOnWorker:t=!1})=>{i=e,a=s,l=n,p=t},_TemplateGenerator:R,_IsJSONFileLoaded:""!==d}})();
