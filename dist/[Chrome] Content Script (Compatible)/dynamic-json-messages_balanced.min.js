const DJM=(()=>{const e={},s={};let n="",o="",t="",r=!0,d=!1;const i=!(!chrome||!chrome.extension),l=!!/^https?/.test(window.location.href),a=async(e="",s)=>{l?chrome.runtime.sendMessage({DJM_LoadJSONFileAsync:!0,jsonFileFullPath:e},e=>{t=e,s(e)}):(o=e,n=o.substr(o.lastIndexOf("/")+1),await fetch(o).then(e=>e.json()).then(e=>{t=e}).catch(e=>console.log(`[DJM] Error loading "${o}": ${e.message}`)).finally(()=>{s&&"function"==typeof s&&s(t)}))},c=({isRefreshable:e=!0,appendResponses:s=!1})=>{l?chrome.runtime.sendMessage({DJM_Settings:!0,data:{isRefreshable:e,appendResponses:s}}):(r=e,d=s)},p={_Exclude:(e="")=>{const s=[];return{_AddExclude:(e="",n)=>{s[s.length]={match:e,active:n}},_GetTemplate:()=>({onProp:e,exclude:s})}}},u=new Worker(URL.createObjectURL(new Blob([`onmessage=${e=>{let s;const n={};!function(e,n){void 0===e.instance?(e.nestedNodes=[],e.savedInfo={},e.skipToNode={},e.dataAttribs={},e.dataIndex=0,e.retrievedResponseNodeLevel=0,e.retrievedResponseValueNodeLevel=0,s=e):s=e.instance,n({key:e.key,response:e.response,excludeTemplate:e.excludeTemplate,canAppendResponses:e.canAppendResponses})}(e.data,e=>{!function(e,o,t,r){let{jsonStringKey:d,reloaded:i,dataAttribs:l,dataIndex:a,retrievedResponseNodeLevel:c,retrievedResponseValueNodeLevel:p}=s;const{nestedNodes:u,jsonFileName:v,jsonStringLoaded:f,savedInfo:h,skipToNode:R}=s;h.allNodesExcluded?(s.savedInfo.allNodesExcluded=void 0,postMessage({type:"recall",data:s})):n.isExcluded||""!==o?""!==o&&function(s){if(void 0===l||!l["*DJM_canResponse"]||n.isExcluded&&!h.resultSentBefore)return;if(void 0===l.response.length)throw new Error(`["${v}" >> "${e}"]\nAll 'response' nested properties must be enclosed as array.`);void 0===R[s]&&(R[s]={});const o=void 0===R[s][h.responseId];o&&x(s,h.responseId,0,0);const{parentResponseNodeLevel:t,returnedResponseValueNodeLevel:r}=function(e,s){let o,t,r,d;n.allReturnedResponseExcluded=void 0;const i=R[e][h.responseId],l=h.lastResponseParentNode.response.length;for(let a=0;a<l;a++){h.lastResponseParentNode.response[a]["*isResponseLevel"]=!0;const c=h.lastResponseParentNode.response[a][e];if(c){const e=c.length;for(let n=0;n<e;n++)if(!D(c[n],!0).excluded&&(void 0===o&&(o=a),void 0===r&&(r=n),a===i.parentResponseNodeLevel&&n>i.returnedResponseNodeLevel||s&&n>=i.returnedResponseNodeLevel||a>i.parentResponseNodeLevel)){t=a,d=n;break}}if(void 0!==t)break;a===l-1?(t=o,d=r,n.allReturnedResponseExcluded=void 0===t&&void 0===d,n.allReturnedResponseExcluded||(h.lastResponseParentNode.response[t]["*DJM_skipped"]=void 0,h.lastResponseParentNode.response[t][e][d]["*DJM_skipped"]=void 0)):h.lastResponseParentNode.response[a]["*DJM_skipped"]=!0}return{parentResponseNodeLevel:t,returnedResponseValueNodeLevel:d}}(s,o);if(n.allReturnedResponseExcluded||void 0===r)return;x(s,h.responseId,t,r),c=R[s][h.responseId].parentResponseNodeLevel,p=R[s][h.responseId].returnedResponseNodeLevel,l["*DJM_canResponse"]=l["*DJM_skipped"]=void 0,l["*DJM_returnedResponse"]=s,h.lastReturnedResponse=s,h.hasResponded=!0,u[u.length]=l,g(l.response,c,!0,l["*DJM_returnedResponse"])}(o):g(d,0);function J(e){l["*DJM_canResponse"]||(l=void 0,h.lastResponseParentNode=void 0),h.resultSentBefore="result"===e,s.excludeTemplate=void 0,s.jsonStringKey=d,s.reloaded=i,s.nestedNodes.length=u.length,s.savedInfo=h,s.skipToNode=R,s.dataAttribs=l,s.dataIndex=a,s.retrievedResponseNodeLevel=c,s.retrievedResponseValueNodeLevel=p,postMessage({type:e,data:s})}function x(e,s,n,o){R[e][s]={parentResponseNodeLevel:n,returnedResponseNodeLevel:o}}function M(e,s,n){R[e]={sequenceNodeLevel:s,updateOnNextTime:n}}function _(e,s,n=!1){const o=e[s];return{exists:void 0!==o,value:o,parentLength:n?Object.values(e).length:void 0}}function D(e,s=!1){let n=!1,o=!1;if(t){const r=t.onProp,d=t.exclude;if(r&&d){const t=_(e,r);if(n=n||t.exists,!n)return{nodeHasOnProp:n,excluded:o};const i=d.length;for(let n=0;n<i;n++){const{match:r,active:i}=d[n],l=t.value===r,a=!!+i;if(o=l&&void 0===i||l&&a,o){e["*DJM_finished"]=!s;break}}}}return{nodeHasOnProp:n,excluded:!e["*DJM_hasPendingResponse"]&&o}}function g(s,o=0,t,x,N,q){try{if(!f)throw new Error(`["${v}" >> "${e}"]\nJSON file not loaded.`);if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nThere's no data for the specified JSON key.`);a=o,l=s[a];const m=a,w=_(l,"sequence",!0),I=_(l,"response"),b=_(l,"*repeatResponse"),O=_(l,"*required"),k=_(l,"*alternate");let y=l&&void 0!==l["*DJM_shown"];const L=l&&void 0!==l["*DJM_finished"];let $=l&&void 0!==l["*DJM_skipped"];if(!y){if(w.exists){const s=l.sequence.length;if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nAll 'sequence' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${v}" >> "${e}"]\nAt least must exist one sequence nested node.`)}else if(I.exists){const s=l.response.length;if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nAll 'response' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${v}" >> "${e}"]\nAt least must exist one response value node on 'response' nested node.`)}else{const n=s.length;if(void 0===n)throw new Error(`["${v}" >> "${e}"]\nAll nodes must be enclosed as array.`);if(0===n)throw new Error(`["${v}" >> "${e}"]\nCan't exist empty nodes.`)}if(I.exists&&w.exists)throw new Error(`["${v}" >> "${e}"]\nNodes must not have both 'response' and 'sequence' properties at the same time.`);if(!I.exists&&b.exists)throw new Error(`["${v}" >> "${e}"]\nThe '*repeatResponse' property must exist on parent response nodes only.`);if(!I.exists&&O.exists)throw new Error(`["${v}" >> "${e}"]\nThe '*required' property must exist on parent response nodes only.`);if(!w.exists&&k.exists)throw new Error(`["${v}" >> "${e}"]\nThe '*alternate' property must exist on parent sequence nodes only.`);0===u.length&&(i&&(i=JSON.parse(JSON.stringify(i))),h.rootNodeIndex=++h.rootNodeIndex||0,c=0),h.resultObject=JSON.parse(JSON.stringify(l)),l["*DJM_shown"]=!1}if(L||(l["*DJM_finished"]=!1),I.exists&&(h.isRepeatResponse=void 0),I.exists&&l["*DJM_shown"]){l["*DJM_canResponse"]=void 0;const e=l.response.length;for(let s=0;s<e&&(a=s,l.response[s]["*DJM_finished"]||l.response[s]["*DJM_skipped"]);s++);if(h.canFlow)return u[u.length]=l,void g(l.response,a,!0,l["*DJM_returnedResponse"],!0);if(!h.hasResponded){n.allReturnedResponseExcluded=void 0;let e=!1;for(let s=u.length-1;s>=0;s--){const n=u[s];if(n.sequence){const s=n["*DJM_sequenceId"];if(!D(n).excluded)if(n["*alternate"])M(s,void 0!==R[s]?R[s].sequenceNodeLevel:0,!0);else{const o=n.sequence.length;for(let t=0;t<o;t++)if($=void 0!==n.sequence[t]["*DJM_skipped"],y=void 0!==n.sequence[t]["*DJM_shown"],!$&&!y){M(`${s}:P`,t),e=!0;break}}}if(e)break}if(u.length=0,h.responseHasPendingAlternateFromParent=void 0,e)h.canFlow=!0,g(d,0);else{if(d.shift(),0===d.length)return h.resultSentBefore=void 0,h.rootNodeIndex=void 0,h.lastResponseParentNode=void 0,c=0,p=0,h.responseId=void 0,h.lastReturnedResponse=void 0,h.lastSequenceIsAlternate=void 0,h.canFlow=void 0,d=i,void g(d,0);g(d,0)}return}}if(t){const s=l[x].length;if(void 0===s)throw new Error(`["${v}" >> "${e}"]\nAll returned response value nested properties must be enclosed as array.`);for(let e=0;e<s&&(a=e,s>1&&p>0&&e<p&&(l[x][e]["*DJM_skipped"]=!0),l[x][e]["*DJM_finished"]||l[x][e]["*DJM_skipped"]);e++);return l["*DJM_shown"]=!0,u[u.length]=l,void g(l[x],a,!1,x,!0)}const j=D(l,N);if(n.isExcluded=j.excluded,!n.isExcluded&&(l["*DJM_shown"]&&w.exists||w.exists&&(1===w.parentLength||(k.exists||j.nodeHasOnProp)&&w.parentLength===2+(j.nodeHasOnProp?1:0)))){l["*DJM_shown"]=!0;let e=!1,s=!1;h.responseHasPendingAlternateFromParent||(l["*DJM_sequenceId"]=`root:${h.rootNodeIndex}-parent_response:${c}-index:${m}-level:${u.length}`);const n=l["*DJM_sequenceId"],o=l["*alternate"]=!!+l["*alternate"];o&&(h.lastSequenceIsAlternate=!0,s=void 0!==R[n],s&&R[n].updateOnNextTime&&M(n,function(e){let s,n;void 0===R[e["*DJM_sequenceId"]]&&M(e["*DJM_sequenceId"],0);const o=e.sequence.length;for(let t=0;t<o;t++){if(!D(e.sequence[t]).excluded&&(void 0===s&&(s=t),t>R[e["*DJM_sequenceId"]].sequenceNodeLevel)){n=t;break}t===o-1&&(n=s)}return n}(l)));const t=l.sequence.length;for(let r=0;r<t&&(a=r,o?!s&&D(l.sequence[r]).excluded?l.sequence[r]["*DJM_skipped"]=e=!0:s&&r<R[n].sequenceNodeLevel&&(l.sequence[r]["*DJM_skipped"]=!0):D(l.sequence[r]).excluded&&(l.sequence[r]["*DJM_skipped"]=!0),void 0!==R[`${n}:P`]&&(r<R[`${n}:P`].sequenceNodeLevel?l.sequence[r]["*DJM_skipped"]=!0:R[`${n}:P`]=void 0),!l.sequence[r]["*DJM_canResponse"]&&(l.sequence[r]["*DJM_finished"]||l.sequence[r]["*DJM_skipped"]||l.sequence[r]["*DJM_done"]));r++);return e&&M(n,a),h.responseHasPendingAlternateFromParent||(u[u.length]=l),void g(l.sequence,a,void 0,void 0,void 0,!0)}if(!l["*DJM_shown"]){if(!n.isExcluded){if(h.resultObject.isSequence=q,q&&h.isAlternate&&(h.resultObject.isAlternate=!0,h.isAlternate=void 0),h.resultObject.isResponse=N,h.resultObject.response=N?x:void 0,I.exists&&(h.resultObject.hasResponse=!0),N&&h.isRepeatResponse&&(h.resultObject.isRepeatResponse=!0,h.isRepeatResponse=void 0),w.exists&&(h.resultObject.hasSequence=!0,h.resultObject.sequence=void 0),k.exists&&(+k.value&&(h.isAlternate=!0,h.resultObject.hasAlternate=!0),h.resultObject["*alternate"]=void 0),b.exists&&(+b.value&&(h.isRepeatResponse=!0,h.resultObject.hasRepeatResponse=!0),h.resultObject["*repeatResponse"]=void 0),O.exists){const e=O.value,s=e=>e&&e.constructor&&e.constructor===Object,n=!!+e;h.resultObject.hasRequired=n||s(e),h.resultObject["*required"]=void 0,h.requiredResult=h.resultObject.hasRequired&&n?h.resultObject:e}if(l["*DJM_shown"]=!0,w.exists||I.exists||(l["*DJM_finished"]=!0),w.exists)h.canFlow=void 0!==h.lastReturnedResponse;else if(I.exists){if(l["*DJM_canResponse"]=l["*DJM_skipped"]=!0,h.canFlow=void 0,h.hasResponded=void 0,h.responseId=l["*DJM_responseId"]=`root:${h.rootNodeIndex}-index:${m}-response:${c}-${void 0===h.responseId||void 0===h.lastReturnedResponse?"default":h.lastReturnedResponse}:${u.length}`,h.lastResponseParentNode=l,h.responseHasPendingAlternateFromParent=h.lastSequenceIsAlternate,r){const e=l.response.map(e=>Object.keys(e)).reduce((e,s)=>e.concat(s));h.resultObject.responses=e.filter((s,n)=>e.indexOf(s)===n)}return h.resultObject.isSequence&&(u[u.length-1]["*DJM_hasPendingResponse"]=!0),void J("result")}}let s=!1,o=!1;if(!n.isExcluded||n.isExcluded&&(q||N)){for(let e=u.length-1;e>=0;e--){const n=u[e],t=void 0!==n.sequence,r=n["*alternate"],d=void 0!==n.response;if((N=n["*isResponseLevel"])&&!o){let e=0;const s=n[h.lastReturnedResponse].length;for(let t=0;t<s;t++)if($=void 0!==n[h.lastReturnedResponse][t]["*DJM_skipped"],$&&e++,n[h.lastReturnedResponse][t]["*DJM_finished"]){o=!0;break}n["*DJM_finished"]=e+(o?1:0)===s}else if(t){s=!0;for(let e=n.sequence.length-1;e>=0&&(n.sequence[e]["*DJM_finished"]||n.sequence[e]["*DJM_skipped"]||n.sequence[e]["*DJM_done"]||n["*alternate"]&&!n.sequence[e]["*DJM_shown"]);e--)n["*DJM_finished"]=0===e,s=!n["*DJM_finished"]}else if(d)if(o)n["*DJM_done"]=!0;else{const e=n.response.length-1;n["*DJM_finished"]=n.response[e]["*DJM_finished"]||n.response[e]["*DJM_skipped"]}if(r&&(n["*DJM_finished"]||n["*DJM_skipped"])&&(currentSequenceId=n["*DJM_sequenceId"],M(currentSequenceId,void 0!==R[currentSequenceId]?R[currentSequenceId].sequenceNodeLevel:0,!0)),o&&s)break}}const t=o&&!s;if((d[0]["*DJM_finished"]||d[0]["*DJM_skipped"]||t)&&d.shift(),t&&(h.responseId=void 0),h.responseHasPendingAlternateFromParent=void 0,c=0,p=0,u.length=0,h.allNodesExcluded=n.isExcluded&&!h.resultSentBefore,0===d.length){if(h.resultSentBefore=void 0,h.rootNodeIndex=void 0,h.responseId=void 0,h.lastResponseParentNode=void 0,h.lastSequenceIsAlternate=void 0,i?(d=i,i=void 0,n.isExcluded?h.allNodesExcluded||g(d,0):J("result")):h.allNodesExcluded||J("recall"),h.allNodesExcluded)throw new Error(`["${v}" >> "${e}"]\nDo not exclude all nodes!`);return}return void(n.isExcluded?g(d,0):J("result"))}}catch(e){h.resultObject=e.message,J("exception")}}}(e.key,e.response,e.excludeTemplate,e.canAppendResponses)})}}`],{type:"application/javascript"}))),v=async(i="",{response:c="",excludeTemplate:p,lock:v=!1,reset:f=!1}={})=>{if(l)return new Promise((e,s)=>{chrome.runtime.sendMessage({DJM_Run:!0,data:{key:i,response:c,excludeTemplate:p,lock:v,reset:f}},n=>{const{success:o,error:t}=n;o?e(o):s(t)})});let h,R;async function J(s){e[i].jsonStringKey=s,x()}async function x(){return new Promise(async(l,M)=>{if(h=h||l,R=R||M,""===t)return void R('First load "DJM._LoadJSONFileAsync()"');let _;if(f?c=(e[i]=s[i]=void 0)||"":s[i]&&""===c?(_=e[i]=s[i],s[i]=void 0):_=e[i],_){if(_.isLoadingJsonFile)return void setTimeout(()=>x(),0);if(v)return void sendResult(_.savedInfo.resultObject);if(_.savedInfo.requiredResult){if(""===c)return _.savedInfo.requiredResult.isRequired=(_.savedInfo.requiredResult.hasRequired=void 0)||!0,d&&(_.savedInfo.requiredResult.responses=_.savedInfo.resultObject.responses),void h(_.savedInfo.requiredResult);_.savedInfo.requiredResult=void 0}_.canPrepareReloaded?e[i].reloaded=t[i]:e[i].reloaded=void 0}u.postMessage(void 0===_?{key:i,jsonFileName:n,jsonStringLoaded:""!==t,jsonStringKey:t[i],reloaded:1===t[i].length,response:c,excludeTemplate:p,canAppendResponses:d}:{key:i,instance:_,response:c,excludeTemplate:p,canAppendResponses:d}),u.onmessage=n=>{const{type:l,data:c}=n.data;if("result"===l){const{resultObject:n}=c.savedInfo,t=c.jsonStringKey.length;let l;if(n.isRepeatResponse?(s[i]={},d&&(c.savedInfo.resultObject.responses=e[i].savedInfo.resultObject.responses),s[i]=c,l=s[i].canPrepareReloaded&&s[i].reloaded,s[i].canPrepareReloaded=1===t):(e[i]=c,l=e[i].canPrepareReloaded&&e[i].reloaded,e[i].canPrepareReloaded=1===t),!l&&t<=1&&r){const n=0===t;s[i]?s[i].isLoadingJsonFile=!0:e[i].isLoadingJsonFile=!0,a(o,o=>{n&&(s[i]?s[i].jsonStringKey=o[i]:e[i].jsonStringKey=o[i]),s[i]?s[i].isLoadingJsonFile=void 0:e[i].isLoadingJsonFile=void 0})}h(n)}else if("recall"===l)e[i]=c,r?a(o,e=>J(e[i])):J(t[i]);else if("exception"===l){const{resultObject:s}=c.savedInfo;e[i]=c,R(s)}}})}return x().then(e=>e).catch(e=>{throw new Error(e)})};return i&&chrome.runtime.onMessage.addListener((e,s,n)=>{if(e.DJM_IsJSONFileLoaded)n(""!==t);else if(e.DJM_LoadJSONFileAsync){const{jsonFileFullPath:s}=e;""===t?a(s,n):n(t)}else if(e.DJM_Settings){const{isRefreshable:s,appendResponses:n}=e.data;c({isRefreshable:s,appendResponses:n})}else if(e.DJM_Run){const{key:s,response:o,excludeTemplate:t,lock:r,reset:d}=e.data;v(s,{response:o,excludeTemplate:t,lock:r,reset:d}).then(e=>n({success:e})).catch(e=>n({error:e}))}return!0}),{_LoadJSONFileAsync:a,_Run:v,_RunDebounced:(e=>{let s;return async(n="",{waitTime:o=300,response:t="",excludeTemplate:r,lock:d=!1,reset:i=!1}={})=>(clearTimeout(s),new Promise(l=>{s=setTimeout(()=>l(e(n,{response:t,excludeTemplate:r,lock:d,reset:i})),o)}))})(v),_Settings:c,_TemplateGenerator:p,_IsJSONFileLoadedAsCallback:e=>{i&&l?chrome.runtime.sendMessage({DJM_IsJSONFileLoaded:!0},s=>e(s)):e(""!==t)}}})();
