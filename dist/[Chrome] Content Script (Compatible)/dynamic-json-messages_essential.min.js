const DJM=(()=>{const e={},s={};let n="",o="",t="",r=!0,d=!1;const i=!(!chrome||!chrome.extension),a=!!/^https?/.test(window.location.href),l=async(e="",s)=>{a?chrome.runtime.sendMessage({DJM_LoadJSONFileAsync:!0,jsonFileFullPath:e},e=>{t=e,s(e)}):(o=e,n=o.substr(o.lastIndexOf("/")+1),await fetch(o).then(e=>e.json()).then(e=>{t=e}).catch(e=>console.log(`[DJM] Error loading "${o}": ${e.message}`)).finally(()=>{s&&"function"==typeof s&&s(t)}))},p=({isRefreshable:e=!0,appendResponses:s=!1})=>{a?chrome.runtime.sendMessage({DJM_Settings:!0,data:{isRefreshable:e,appendResponses:s}}):(r=e,d=s)},c=new Worker(URL.createObjectURL(new Blob([`onmessage=${e=>{let s;!function(e,n){void 0===e.instance?(e.nestedNodes=[],e.savedInfo={},e.skipToNode={},e.dataAttribs={},e.dataIndex=0,e.retrievedResponseNodeLevel=0,e.retrievedResponseValueNodeLevel=0,s=e):s=e.instance,n({key:e.key,response:e.response,canAppendResponses:e.canAppendResponses})}(e.data,e=>{!function(e,n,o){let{jsonStringKey:t,reloaded:r,dataAttribs:d,dataIndex:i,retrievedResponseNodeLevel:a,retrievedResponseValueNodeLevel:l}=s;const{nestedNodes:p,jsonFileName:c,jsonStringLoaded:u,savedInfo:v,skipToNode:f}=s;""===n?_(t,0):function(s){if(void 0===d||!d["*DJM_canResponse"])return;if(void 0===d.response.length)throw new Error(`["${c}" >> "${e}"]\nAll 'response' nested properties must be enclosed as array.`);void 0===f[s]&&(f[s]={});const n=void 0===f[s][v.responseId];n&&R(s,v.responseId,0,0);const{parentResponseNodeLevel:o,returnedResponseValueNodeLevel:t}=function(e,s){let n,o,t,r;const d=f[e][v.responseId],i=v.lastResponseParentNode.response.length;for(let a=0;a<i;a++){v.lastResponseParentNode.response[a]["*isResponseLevel"]=!0;const l=v.lastResponseParentNode.response[a][e];if(l){const e=l.length;for(let i=0;i<e;i++)if(void 0===n&&(n=a),void 0===t&&(t=i),a===d.parentResponseNodeLevel&&i>d.returnedResponseNodeLevel||s&&i>=d.returnedResponseNodeLevel||a>d.parentResponseNodeLevel){o=a,r=i;break}}if(void 0!==o)break;a===i-1?(o=n,r=t,v.lastResponseParentNode.response[o]["*DJM_skipped"]=void 0,v.lastResponseParentNode.response[o][e][r]["*DJM_skipped"]=void 0):v.lastResponseParentNode.response[a]["*DJM_skipped"]=!0}return{parentResponseNodeLevel:o,returnedResponseValueNodeLevel:r}}(s,n);if(void 0===t)return;R(s,v.responseId,o,t),a=f[s][v.responseId].parentResponseNodeLevel,l=f[s][v.responseId].returnedResponseNodeLevel,d["*DJM_canResponse"]=d["*DJM_skipped"]=void 0,d["*DJM_returnedResponse"]=s,v.lastReturnedResponse=s,v.hasResponded=!0,p[p.length]=d,_(d.response,a,!0,d["*DJM_returnedResponse"])}(n);function h(e){d["*DJM_canResponse"]||(d=void 0,v.lastResponseParentNode=void 0),s.jsonStringKey=t,s.reloaded=r,s.nestedNodes.length=p.length,s.savedInfo=v,s.skipToNode=f,s.dataAttribs=d,s.dataIndex=i,s.retrievedResponseNodeLevel=a,s.retrievedResponseValueNodeLevel=l,postMessage({type:e,data:s})}function R(e,s,n,o){f[e][s]={parentResponseNodeLevel:n,returnedResponseNodeLevel:o}}function J(e,s,n){f[e]={sequenceNodeLevel:s,updateOnNextTime:n}}function M(e,s,n=!1){const o=e[s];return{exists:void 0!==o,value:o,parentLength:n?Object.values(e).length:void 0}}function _(s,n=0,R,D,g,N){try{if(!u)throw new Error(`["${c}" >> "${e}"]\nJSON file not loaded.`);if(void 0===s)throw new Error(`["${c}" >> "${e}"]\nThere's no data for the specified JSON key.`);i=n,d=s[i];const q=i,I=M(d,"sequence",!0),b=M(d,"response"),w=M(d,"*repeatResponse"),x=M(d,"*required"),L=M(d,"*alternate");let O=d&&void 0!==d["*DJM_shown"];const m=d&&void 0!==d["*DJM_finished"];let y=d&&void 0!==d["*DJM_skipped"];if(!O){if(I.exists){const s=d.sequence.length;if(void 0===s)throw new Error(`["${c}" >> "${e}"]\nAll 'sequence' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${c}" >> "${e}"]\nAt least must exist one sequence nested node.`)}else if(b.exists){const s=d.response.length;if(void 0===s)throw new Error(`["${c}" >> "${e}"]\nAll 'response' nested nodes must be enclosed as array.`);if(0===s)throw new Error(`["${c}" >> "${e}"]\nAt least must exist one response value node on 'response' nested node.`)}else{const n=s.length;if(void 0===n)throw new Error(`["${c}" >> "${e}"]\nAll nodes must be enclosed as array.`);if(0===n)throw new Error(`["${c}" >> "${e}"]\nCan't exist empty nodes.`)}if(b.exists&&I.exists)throw new Error(`["${c}" >> "${e}"]\nNodes must not have both 'response' and 'sequence' properties at the same time.`);if(!b.exists&&w.exists)throw new Error(`["${c}" >> "${e}"]\nThe '*repeatResponse' property must exist on parent response nodes only.`);if(!b.exists&&x.exists)throw new Error(`["${c}" >> "${e}"]\nThe '*required' property must exist on parent response nodes only.`);if(!I.exists&&L.exists)throw new Error(`["${c}" >> "${e}"]\nThe '*alternate' property must exist on parent sequence nodes only.`);0===p.length&&(r&&(r=JSON.parse(JSON.stringify(r))),v.rootNodeIndex=++v.rootNodeIndex||0,a=0),v.resultObject=JSON.parse(JSON.stringify(d)),d["*DJM_shown"]=!1}if(m||(d["*DJM_finished"]=!1),b.exists&&(v.isRepeatResponse=void 0),b.exists&&d["*DJM_shown"]){d["*DJM_canResponse"]=void 0;const e=d.response.length;for(let s=0;s<e&&(i=s,d.response[s]["*DJM_finished"]||d.response[s]["*DJM_skipped"]);s++);if(v.canFlow)return p[p.length]=d,void _(d.response,i,!0,d["*DJM_returnedResponse"],!0);if(!v.hasResponded){let e=!1;for(let s=p.length-1;s>=0;s--){const n=p[s];if(n.sequence){const s=n["*DJM_sequenceId"];if(n["*alternate"])J(s,void 0!==f[s]?f[s].sequenceNodeLevel:0,!0);else{const o=n.sequence.length;for(let t=0;t<o;t++)if(y=void 0!==n.sequence[t]["*DJM_skipped"],O=void 0!==n.sequence[t]["*DJM_shown"],!y&&!O){J(`${s}:P`,t),e=!0;break}}}if(e)break}if(p.length=0,v.responseHasPendingAlternateFromParent=void 0,e)v.canFlow=!0,_(t,0);else{if(t.shift(),0===t.length)return v.rootNodeIndex=void 0,v.lastResponseParentNode=void 0,a=0,l=0,v.responseId=void 0,v.lastReturnedResponse=void 0,v.lastSequenceIsAlternate=void 0,v.canFlow=void 0,t=r,void _(t,0);_(t,0)}return}}if(R){const s=d[D].length;if(void 0===s)throw new Error(`["${c}" >> "${e}"]\nAll returned response value nested properties must be enclosed as array.`);for(let e=0;e<s&&(i=e,s>1&&l>0&&e<l&&(d[D][e]["*DJM_skipped"]=!0),d[D][e]["*DJM_finished"]||d[D][e]["*DJM_skipped"]);e++);return d["*DJM_shown"]=!0,p[p.length]=d,void _(d[D],i,!1,D,!0)}if(d["*DJM_shown"]&&I.exists||I.exists&&(1===I.parentLength||L.exists&&2===I.parentLength)){d["*DJM_shown"]=!0;let e=!1;v.responseHasPendingAlternateFromParent||(d["*DJM_sequenceId"]=`root:${v.rootNodeIndex}-parent_response:${a}-index:${q}-level:${p.length}`);const s=d["*DJM_sequenceId"],n=d["*alternate"]=!!+d["*alternate"];n&&(v.lastSequenceIsAlternate=!0,e=void 0!==f[s],e&&f[s].updateOnNextTime&&J(s,function(e){let s,n;void 0===f[e["*DJM_sequenceId"]]&&J(e["*DJM_sequenceId"],0);const o=e.sequence.length;for(let t=0;t<o;t++){if(void 0===s&&(s=t),t>f[e["*DJM_sequenceId"]].sequenceNodeLevel){n=t;break}t===o-1&&(n=s)}return n}(d)));const o=d.sequence.length;for(let t=0;t<o&&(i=t,n&&e&&t<f[s].sequenceNodeLevel&&(d.sequence[t]["*DJM_skipped"]=!0),void 0!==f[`${s}:P`]&&(t<f[`${s}:P`].sequenceNodeLevel?d.sequence[t]["*DJM_skipped"]=!0:f[`${s}:P`]=void 0),!d.sequence[t]["*DJM_canResponse"]&&(d.sequence[t]["*DJM_finished"]||d.sequence[t]["*DJM_skipped"]||d.sequence[t]["*DJM_done"]));t++);return v.responseHasPendingAlternateFromParent||(p[p.length]=d),void _(d.sequence,i,void 0,void 0,void 0,!0)}if(!d["*DJM_shown"]){if(v.resultObject.isSequence=N,N&&v.isAlternate&&(v.resultObject.isAlternate=!0,v.isAlternate=void 0),v.resultObject.isResponse=g,v.resultObject.response=g?D:void 0,b.exists&&(v.resultObject.hasResponse=!0),g&&v.isRepeatResponse&&(v.resultObject.isRepeatResponse=!0,v.isRepeatResponse=void 0),I.exists&&(v.resultObject.hasSequence=!0,v.resultObject.sequence=void 0),L.exists&&(+L.value&&(v.isAlternate=!0,v.resultObject.hasAlternate=!0),v.resultObject["*alternate"]=void 0),w.exists&&(+w.value&&(v.isRepeatResponse=!0,v.resultObject.hasRepeatResponse=!0),v.resultObject["*repeatResponse"]=void 0),x.exists){const e=x.value,s=e=>e&&e.constructor&&e.constructor===Object,n=!!+e;v.resultObject.hasRequired=n||s(e),v.resultObject["*required"]=void 0,v.requiredResult=v.resultObject.hasRequired&&n?v.resultObject:e}if(d["*DJM_shown"]=!0,I.exists||b.exists||(d["*DJM_finished"]=!0),I.exists)v.canFlow=void 0!==v.lastReturnedResponse;else if(b.exists){if(d["*DJM_canResponse"]=d["*DJM_skipped"]=!0,v.canFlow=void 0,v.hasResponded=void 0,v.responseId=d["*DJM_responseId"]=`root:${v.rootNodeIndex}-index:${q}-response:${a}-${void 0===v.responseId||void 0===v.lastReturnedResponse?"default":v.lastReturnedResponse}:${p.length}`,v.lastResponseParentNode=d,v.responseHasPendingAlternateFromParent=v.lastSequenceIsAlternate,o){const e=d.response.map(e=>Object.keys(e)).reduce((e,s)=>e.concat(s));v.resultObject.responses=e.filter((s,n)=>e.indexOf(s)===n)}return void h("result")}let e=!1,s=!1;for(let n=p.length-1;n>=0;n--){const o=p[n],t=void 0!==o.sequence,r=o["*alternate"],d=void 0!==o.response;if((g=o["*isResponseLevel"])&&!s){let e=0;const n=o[v.lastReturnedResponse].length;for(let t=0;t<n;t++)if(y=void 0!==o[v.lastReturnedResponse][t]["*DJM_skipped"],y&&e++,o[v.lastReturnedResponse][t]["*DJM_finished"]){s=!0;break}o["*DJM_finished"]=e+(s?1:0)===n}else if(t){e=!0;for(let s=o.sequence.length-1;s>=0&&(o.sequence[s]["*DJM_finished"]||o.sequence[s]["*DJM_skipped"]||o.sequence[s]["*DJM_done"]||o["*alternate"]&&!o.sequence[s]["*DJM_shown"]);s--)o["*DJM_finished"]=0===s,e=!o["*DJM_finished"]}else if(d)if(s)o["*DJM_done"]=!0;else{const e=o.response.length-1;o["*DJM_finished"]=o.response[e]["*DJM_finished"]||o.response[e]["*DJM_skipped"]}if(r&&(o["*DJM_finished"]||o["*DJM_skipped"])&&(currentSequenceId=o["*DJM_sequenceId"],J(currentSequenceId,void 0!==f[currentSequenceId]?f[currentSequenceId].sequenceNodeLevel:0,!0)),s&&e)break}const n=s&&!e;return(t[0]["*DJM_finished"]||t[0]["*DJM_skipped"]||n)&&t.shift(),n&&(v.responseId=void 0),v.responseHasPendingAlternateFromParent=void 0,a=0,l=0,p.length=0,0===t.length&&(v.rootNodeIndex=void 0,v.responseId=void 0,v.lastResponseParentNode=void 0,v.lastSequenceIsAlternate=void 0,t=r,r=void 0),void h("result")}}catch(e){v.resultObject=e.message,h("exception")}}}(e.key,e.response,e.canAppendResponses)})}}`],{type:"application/javascript"}))),u=async(i="",{response:p="",lock:u=!1,reset:v=!1}={})=>{if(a)return new Promise((e,s)=>{chrome.runtime.sendMessage({DJM_Run:!0,data:{key:i,response:p,lock:u,reset:v}},n=>{const{success:o,error:t}=n;o?e(o):s(t)})});let f,h;async function R(s){e[i].jsonStringKey=s,J()}async function J(){return new Promise(async(a,M)=>{if(f=f||a,h=h||M,""===t)return void h('First load "DJM._LoadJSONFileAsync()"');let _;if(v?p=(e[i]=s[i]=void 0)||"":s[i]&&""===p?(_=e[i]=s[i],s[i]=void 0):_=e[i],_){if(_.isLoadingJsonFile)return void setTimeout(()=>J(),0);if(u)return void sendResult(_.savedInfo.resultObject);if(_.savedInfo.requiredResult){if(""===p)return _.savedInfo.requiredResult.isRequired=(_.savedInfo.requiredResult.hasRequired=void 0)||!0,d&&(_.savedInfo.requiredResult.responses=_.savedInfo.resultObject.responses),void f(_.savedInfo.requiredResult);_.savedInfo.requiredResult=void 0}_.canPrepareReloaded?e[i].reloaded=t[i]:e[i].reloaded=void 0}c.postMessage(void 0===_?{key:i,jsonFileName:n,jsonStringLoaded:""!==t,jsonStringKey:t[i],response:p,canAppendResponses:d}:{key:i,instance:_,response:p,canAppendResponses:d}),c.onmessage=n=>{const{type:a,data:p}=n.data;if("result"===a){const{resultObject:n}=p.savedInfo,t=p.jsonStringKey.length;let a;if(n.isRepeatResponse?(s[i]={},d&&(p.savedInfo.resultObject.responses=e[i].savedInfo.resultObject.responses),s[i]=p,a=s[i].canPrepareReloaded&&s[i].reloaded,s[i].canPrepareReloaded=1===t):(e[i]=p,a=e[i].canPrepareReloaded&&e[i].reloaded,e[i].canPrepareReloaded=1===t),!a&&t<=1&&r){const n=0===t;s[i]?s[i].isLoadingJsonFile=!0:e[i].isLoadingJsonFile=!0,l(o,o=>{n&&(s[i]?s[i].jsonStringKey=o[i]:e[i].jsonStringKey=o[i]),s[i]?s[i].isLoadingJsonFile=void 0:e[i].isLoadingJsonFile=void 0})}f(n)}else if("recall"===a)e[i]=p,r?l(o,e=>R(e[i])):R(t[i]);else if("exception"===a){const{resultObject:s}=p.savedInfo;e[i]=p,h(s)}}})}return J().then(e=>e).catch(e=>{throw new Error(e)})};return i&&chrome.runtime.onMessage.addListener((e,s,n)=>{if(e.DJM_IsJSONFileLoaded)n(""!==t);else if(e.DJM_LoadJSONFileAsync){const{jsonFileFullPath:s}=e;""===t?l(s,n):n(t)}else if(e.DJM_Settings){const{isRefreshable:s,appendResponses:n}=e.data;p({isRefreshable:s,appendResponses:n})}else if(e.DJM_Run){const{key:s,response:o,excludeTemplate:t,lock:r,reset:d}=e.data;u(s,{response:o,excludeTemplate:t,lock:r,reset:d}).then(e=>n({success:e})).catch(e=>n({error:e}))}return!0}),{_LoadJSONFileAsync:l,_Run:u,_Settings:p,_IsJSONFileLoadedAsCallback:e=>{i&&a?chrome.runtime.sendMessage({DJM_IsJSONFileLoaded:!0},s=>e(s)):e(""!==t)}}})();
